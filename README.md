# Oak

## 数据采集

雷达倒置，x轴水平向上30°，记雷达坐标系(FRD坐标系)为O1。以目标区域为原点建立FLU坐标系，记为O2，采集时雷达定位于该坐标系下(1.5, 0, 1)的区域。雷达进行3000ms的积分后获取累积点云数据。

## 数据预处理

规定计算区域为O2坐标系下[(-a, -b, -c); (a, b, c)]的矩形包围盒区域，记为L2。首先把包围盒区域变换到雷达坐标系，得到O1坐标系下包围盒L1。在原始点云中根据包围盒进行截取，得到目标点云集合D1。

## 数据分析

### 去除地面植被和灌木

原始数据中得到的点云数据受到地面植被的影响，存在大量草地的噪点和灌木的小团簇。在进行地形建模前，需要首先去除植被的杂波。

对点云原始数据D1，使用RANSAC算法进行地面的粗拟合，以达到去除灌木等植被的效果。

去除灌木后，对D1进行栅格化。由于去除了灌木，我们可以认为在每个栅格内，仅存在一层点云结构，即地面和地表草本植被的混合点云数据。如果将栅格划分足够小，可以认为每个栅格内的地面均为平面。以此为思路，使用RANSAC等算法，可以较好的去除植被噪声。

### 原始数据与当次测得数据的配准

使用ICP算法计算两幅点云的旋转矩阵和平移矩阵，便于将两幅点云对齐到同一个相对位置下。

对准后通过两幅点云的叠加或并排显示可以用于观察地形的形变等

### 地形重建

正在开发。在此前去除植被噪声时计算的栅格化地图可以用于地形重建。

### 流程

- 读取点云文件
- ransac拟合地面，实现去除杂波
- 把点云分为小cell，进行表面重建

#### 表面重建流程

##### 建立栅格索引

按 cell_size 将每个点落入二维网格 (i32, i32)
用`HashMap`聚合每个格子内的点

##### 计算每个格子的平均高度`z`

构建`height_map`，保存每个格子中心的 z 值（平均高度）

##### 填补缺失格子

对于缺失的格子，尝试用邻居格子的平均`z`值进行插值

##### 构建顶点和索引

每个格子为一个四边形，由两个三角形组成
构造索引序列形成网格

##### 计算法线

使用三角面法线累加平均，得到每个顶点的法线

##### 生成颜色

利用法线的`z`分量计算坡度（陡度）并映射为颜色
